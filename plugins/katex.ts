import { fromHtmlIsomorphic } from "hast-util-from-html-isomorphic";
import { toText } from "hast-util-to-text";
import katex from "katex";
import { SKIP, visitParents } from "unist-util-visit-parents";
import type { KatexOptions } from "katex";
import type { Element } from "hast";
import type { Root } from "remark-directive";
import type { VFile } from "vfile";

type Options = Omit<KatexOptions, "displayMode" | "throwOnError">;

const initializeCustomFont = () => {
  console.log("Initializing custom font...");
  // All of these are textords in math mode
  const mathTextSymbols = '0123456789/@."';
  for (let i = 0; i < mathTextSymbols.length; i++) {
    const ch = mathTextSymbols.charAt(i);
    katex.__defineSymbol("math", "custom", "textord", ch, ch);
  }

  // All of these are textords in text mode
  const textSymbols = '0123456789!@*()-=+";:?/.,';
  for (let i = 0; i < textSymbols.length; i++) {
    const ch = textSymbols.charAt(i);
    katex.__defineSymbol("text", "custom", "textord", ch, ch);
  }

  // All of these are textords in text mode, and mathords in math mode
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
  for (let i = 0; i < letters.length; i++) {
    const ch = letters.charAt(i);
    katex.__defineSymbol("math", "custom", "mathord", ch, ch);
    katex.__defineSymbol("text", "custom", "textord", ch, ch);
  }

  //   ◊; katex.__defineSymbol("math", "custom", "textord", "Q", "\u211A");
  //   ◊; katex.__defineSymbol("text", "custom","textord", "Q", "\u211A");

  //   katex.__defineSymbol("math", "custom", "textord", "ε", "\u03B5");
  //   katex.__defineSymbol("text", "custom","textord", "ε", "\u03B5");

  //   ◊; const customMetrics = {"32": [0, 0, 0, 0, 0.267578125], "160": [0, 0, 0, 0, 0.267578125], "65": [0.0, 0.68798828125, 0, 0, 0.716796875], "66": [0.0, 0.69189453125, 0, 0, 0.6787109375], "67": [0.01318359375, 0.703125, 0, 0, 0.763671875], "68": [0.0, 0.69384765625, 0, 0, 0.8115234375], "69": [0.0, 0.68798828125, 0, 0, 0.61669921875], "70": [0.0, 0.68798828125, 0, 0, 0.56884765625], "71": [0.01318359375, 0.703125, 0, 0, 0.79052734375], "72": [0.0, 0.689453125, 0, 0, 0.8349609375], "73": [0.0, 0.689453125, 0, 0, 0.3408203125], "74": [0.31201171875, 0.689453125, 0, 0, 0.31982421875], "75": [0.0, 0.689453125, 0, 0, 0.74365234375], "76": [0.0, 0.68798828125, 0, 0, 0.603515625], "77": [0.0, 0.68798828125, 0, 0, 0.94091796875], "78": [0.005859375, 0.68798828125, 0, 0, 0.8525390625], "79": [0.01318359375, 0.703125, 0, 0, 0.86376953125], "80": [0.0, 0.69580078125, 0, 0, 0.61962890625], "81": [0.208984375, 0.7021484375, 0, 0, 0.86181640625], "82": [0.01220703125, 0.69580078125, 0, 0, 0.69189453125], "83": [0.01318359375, 0.703125, 0, 0, 0.51953125], "84": [0.0, 0.7080078125, 0, 0, 0.73291015625], "85": [0.01318359375, 0.689453125, 0, 0, 0.81591796875], "86": [0.01318359375, 0.689453125, 0, 0, 0.73388671875], "87": [0.01318359375, 0.689453125, 0, 0, 1.11474609375], "88": [0.0, 0.68798828125, 0, 0, 0.78564453125], "89": [0.0, 0.68798828125, 0, 0, 0.7529296875], "90": [0.0, 0.68798828125, 0, 0, 0.7119140625], "97": [0.01318359375, 0.453125, 0, 0, 0.431640625], "98": [0.01318359375, 0.80322265625, 0, 0, 0.53564453125], "99": [0.01318359375, 0.453125, 0, 0, 0.45556640625], "100": [0.01318359375, 0.80322265625, 0, 0, 0.53173828125], "101": [0.01318359375, 0.453125, 0, 0, 0.45361328125], "102": [0.0, 0.8017578125, 0, 0, 0.3037109375], "103": [0.31201171875, 0.4541015625, 0, 0, 0.5595703125], "104": [0.0, 0.80322265625, 0, 0, 0.560546875], "105": [0.0, 0.68701171875, 0, 0, 0.28076171875], "106": [0.31201171875, 0.68701171875, 0, 0, 0.28076171875], "107": [0.0, 0.80322265625, 0, 0, 0.53466796875], "108": [0.0, 0.80322265625, 0, 0, 0.25390625], "109": [0.0, 0.47705078125, 0, 0, 0.8447265625], "110": [0.0, 0.47705078125, 0, 0, 0.56787109375], "111": [0.01318359375, 0.4541015625, 0, 0, 0.53955078125], "112": [0.30322265625, 0.47705078125, 0, 0, 0.5185546875], "113": [0.30322265625, 0.45703125, 0, 0, 0.53466796875], "114": [0.0, 0.453125, 0, 0, 0.388671875], "115": [0.01318359375, 0.453125, 0, 0, 0.333984375], "116": [0.01318359375, 0.51904296875, 0, 0, 0.31494140625], "117": [0.01318359375, 0.453125, 0, 0, 0.5478515625], "118": [0.01318359375, 0.4404296875, 0, 0, 0.5048828125], "119": [0.01318359375, 0.4404296875, 0, 0, 0.80078125], "120": [0.0, 0.4404296875, 0, 0, 0.49560546875], "121": [0.31201171875, 0.4404296875, 0, 0, 0.53662109375], "122": [0.0, 0.458984375, 0, 0, 0.44580078125], "48": [0.01318359375, 0.6728515625, 0, 0, 0.51171875], "49": [0.0, 0.6728515625, 0, 0, 0.51171875], "50": [0.0, 0.6728515625, 0, 0, 0.51171875], "51": [0.01318359375, 0.6728515625, 0, 0, 0.51171875], "52": [0.01806640625, 0.6728515625, 0, 0, 0.51171875], "53": [0.01318359375, 0.6728515625, 0, 0, 0.51171875], "54": [0.01318359375, 0.671875, 0, 0, 0.51171875], "55": [0.01318359375, 0.65283203125, 0, 0, 0.51171875], "56": [0.01318359375, 0.6728515625, 0, 0, 0.51171875], "57": [0.01220703125, 0.6728515625, 0, 0, 0.51171875], "33": [0.01318359375, 0.72900390625, 0, 0, 0.23779296875], "64": [0.216796875, 0.7021484375, 0, 0, 0.9716796875], "42": [-0.46923828125, 0.77783203125, 0, 0, 0.36083984375], "40": [0.255859375, 0.84619140625, 0, 0, 0.31689453125], "41": [0.255859375, 0.84619140625, 0, 0, 0.31689453125], "45": [-0.21484375, 0.2822265625, 0, 0, 0.44482421875], "61": [-0.19091796875, 0.4189453125, 0, 0, 0.51171875], "43": [-0.0859375, 0.52587890625, 0, 0, 0.51171875], "34": [-0.39794921875, 0.68798828125, 0, 0, 0.40673828125], "59": [0.14013671875, 0.4541015625, 0, 0, 0.2529296875], "58": [0.01318359375, 0.4541015625, 0, 0, 0.2529296875], "63": [0.01318359375, 0.69091796875, 0, 0, 0.37890625], "47": [0.01318359375, 0.708984375, 0, 0, 0.32373046875], "46": [0.01318359375, 0.11376953125, 0, 0, 0.2529296875], "44": [0.14013671875, 0.115234375, 0, 0, 0.2529296875]};
  // fbb-regular.ttf
  const customMetrics = {
    32: [0, 0, 0, 0, 0.267578125],
    160: [0, 0, 0, 0, 0.267578125],
    65: [0.0, 0.68798828125, 0, 0, 0.716796875],
    66: [0.0, 0.69189453125, 0, 0, 0.6787109375],
    67: [0.01318359375, 0.703125, 0, 0, 0.763671875],
    68: [0.0, 0.69384765625, 0, 0, 0.8115234375],
    69: [0.0, 0.68798828125, 0, 0, 0.61669921875],
    70: [0.0, 0.68798828125, 0, 0, 0.56884765625],
    71: [0.01318359375, 0.703125, 0, 0, 0.79052734375],
    72: [0.0, 0.689453125, 0, 0, 0.8349609375],
    73: [0.0, 0.689453125, 0, 0, 0.3408203125],
    74: [0.31201171875, 0.689453125, 0, 0, 0.31982421875],
    75: [0.0, 0.689453125, 0, 0, 0.74365234375],
    76: [0.0, 0.68798828125, 0, 0, 0.603515625],
    77: [0.0, 0.68798828125, 0, 0, 0.94091796875],
    78: [0.005859375, 0.68798828125, 0, 0, 0.8525390625],
    79: [0.01318359375, 0.703125, 0, 0, 0.86376953125],
    80: [0.0, 0.69580078125, 0, 0, 0.61962890625],
    81: [0.208984375, 0.7021484375, 0, 0, 0.86181640625],
    82: [0.01220703125, 0.69580078125, 0, 0, 0.69189453125],
    83: [0.01318359375, 0.703125, 0, 0, 0.51953125],
    84: [0.0, 0.7080078125, 0, 0, 0.73291015625],
    85: [0.01318359375, 0.689453125, 0, 0, 0.81591796875],
    86: [0.01318359375, 0.689453125, 0, 0, 0.73388671875],
    87: [0.01318359375, 0.689453125, 0, 0, 1.11474609375],
    88: [0.0, 0.68798828125, 0, 0, 0.78564453125],
    89: [0.0, 0.68798828125, 0, 0, 0.7529296875],
    90: [0.0, 0.68798828125, 0, 0, 0.7119140625],
    97: [0.01318359375, 0.453125, 0, 0, 0.431640625],
    98: [0.01318359375, 0.80322265625, 0, 0, 0.53564453125],
    99: [0.01318359375, 0.453125, 0, 0, 0.45556640625],
    100: [0.01318359375, 0.80322265625, 0, 0, 0.53173828125],
    101: [0.01318359375, 0.453125, 0, 0, 0.45361328125],
    102: [0.0, 0.8017578125, 0, 0, 0.3037109375],
    103: [0.31201171875, 0.4541015625, 0, 0, 0.5595703125],
    104: [0.0, 0.80322265625, 0, 0, 0.560546875],
    105: [0.0, 0.68701171875, 0, 0, 0.28076171875],
    106: [0.31201171875, 0.68701171875, 0, 0, 0.28076171875],
    107: [0.0, 0.80322265625, 0, 0, 0.53466796875],
    108: [0.0, 0.80322265625, 0, 0, 0.25390625],
    109: [0.0, 0.47705078125, 0, 0, 0.8447265625],
    110: [0.0, 0.47705078125, 0, 0, 0.56787109375],
    111: [0.01318359375, 0.4541015625, 0, 0, 0.53955078125],
    112: [0.30322265625, 0.47705078125, 0, 0, 0.5185546875],
    113: [0.30322265625, 0.45703125, 0, 0, 0.53466796875],
    114: [0.0, 0.453125, 0, 0, 0.388671875],
    115: [0.01318359375, 0.453125, 0, 0, 0.333984375],
    116: [0.01318359375, 0.51904296875, 0, 0, 0.31494140625],
    117: [0.01318359375, 0.453125, 0, 0, 0.5478515625],
    118: [0.01318359375, 0.4404296875, 0, 0, 0.5048828125],
    119: [0.01318359375, 0.4404296875, 0, 0, 0.80078125],
    120: [0.0, 0.4404296875, 0, 0, 0.49560546875],
    121: [0.31201171875, 0.4404296875, 0, 0, 0.53662109375],
    122: [0.0, 0.458984375, 0, 0, 0.44580078125],
    48: [0.01318359375, 0.6728515625, 0, 0, 0.51171875],
    49: [0.0, 0.6728515625, 0, 0, 0.51171875],
    50: [0.0, 0.6728515625, 0, 0, 0.51171875],
    51: [0.01318359375, 0.6728515625, 0, 0, 0.51171875],
    52: [0.01806640625, 0.6728515625, 0, 0, 0.51171875],
    53: [0.01318359375, 0.6728515625, 0, 0, 0.51171875],
    54: [0.01318359375, 0.671875, 0, 0, 0.51171875],
    55: [0.01318359375, 0.65283203125, 0, 0, 0.51171875],
    56: [0.01318359375, 0.6728515625, 0, 0, 0.51171875],
    57: [0.01220703125, 0.6728515625, 0, 0, 0.51171875],
    33: [0.01318359375, 0.72900390625, 0, 0, 0.23779296875],
    64: [0.216796875, 0.7021484375, 0, 0, 0.9716796875],
    42: [-0.46923828125, 0.77783203125, 0, 0, 0.36083984375],
    40: [0.255859375, 0.84619140625, 0, 0, 0.31689453125],
    41: [0.255859375, 0.84619140625, 0, 0, 0.31689453125],
    45: [-0.21484375, 0.2822265625, 0, 0, 0.44482421875],
    61: [-0.19091796875, 0.4189453125, 0, 0, 0.51171875],
    43: [-0.0859375, 0.52587890625, 0, 0, 0.51171875],
    34: [-0.39794921875, 0.68798828125, 0, 0, 0.40673828125],
    59: [0.14013671875, 0.4541015625, 0, 0, 0.2529296875],
    58: [0.01318359375, 0.4541015625, 0, 0, 0.2529296875],
    63: [0.01318359375, 0.69091796875, 0, 0, 0.37890625],
    47: [0.01318359375, 0.708984375, 0, 0, 0.32373046875],
    46: [0.01318359375, 0.11376953125, 0, 0, 0.2529296875],
    44: [0.14013671875, 0.115234375, 0, 0, 0.2529296875],
  };
  //   ◊; const customMetrics = {};
  katex.__setFontMetrics("custom-Regular", customMetrics);
  katex.__setFontMetrics("Math-Italic", customMetrics); // makeOrd turns all mathematics into "Math-Italic" regardless of requested font
  katex.__setFontMetrics("AMS-Regular", customMetrics); // mathsym turns "custom" font into "ams"
};

initializeCustomFont();

export const rehypeKatex = (options: Options) => {
  const settings = options || {};

  return (tree: Root, file: VFile) => {
    visitParents(tree, "element", (element: Element, parents: Element[]) => {
      if (!element) return;
      const classes = Array.isArray(element?.properties?.className)
        ? element.properties?.className ?? []
        : [];
      // This class can be generated from markdown with ` ```math `.
      // console.log({ ...element, classes });
      const languageMath = classes.includes("language-math");
      // This class is used by `remark-math` for flow math (block, `$$\nmath\n$$`).
      const mathDisplay = classes.includes("math-display");
      // This class is used by `remark-math` for text math (inline, `$math$`).
      const mathInline = classes.includes("math-inline");
      const myMath = classes.includes("my-math");
      let displayMode = mathDisplay;

      // Any class is fine.
      if (!languageMath && !mathDisplay && !mathInline && !myMath) {
        return;
      }

      let parent = parents[parents.length - 1];
      let scope: Element = element;

      // If this was generated with ` ```math `, replace the `<pre>` and use
      // display.
      if (
        (element.tagName === "code" &&
          languageMath &&
          parent &&
          parent.type === "element" &&
          parent.tagName === "pre") ||
        (element.tagName === "div" &&
          myMath &&
          parent &&
          parent.type === "element" &&
          parent.tagName === "pre")
      ) {
        scope = parent;
        parent = parents[parents.length - 2];
        displayMode = true;
      }

      /* c8 ignore next -- verbose to test. */
      if (!parent) return;
      if (scope.properties === undefined) return;

      const value = toText(scope as any, { whitespace: "pre" });

      /** @type {Array<ElementContent> | string | undefined} */
      let result;

      try {
        result = katex.renderToString(value, {
          ...settings,
          displayMode,
          throwOnError: true,
        });
      } catch (error) {
        const cause = error as Error;
        const ruleId = cause.name.toLowerCase();

        file.message("Could not render math with KaTeX", {
          ancestors: [...parents, element],
          cause,
          place: element.position,
          ruleId,
          source: "rehype-katex",
          type: element.type,
        });

        // KaTeX can handle `ParseError` itself, but not others.
        if (ruleId === "parseerror") {
          result = katex.renderToString(value, {
            ...settings,
            displayMode,
            strict: "ignore",
            throwOnError: false,
          });
        }
        // Generate similar markup if this is an other error.
        // See: <https://github.com/KaTeX/KaTeX/blob/5dc7af0/docs/error.md>.
        else {
          result = [
            {
              type: "element",
              tagName: "span",
              properties: {
                className: ["katex-error"],
                style: "color:" + (settings.errorColor || "#cc0000"),
                title: String(error),
              },
              children: [{ type: "text", value }],
            },
          ];
        }
      }

      if (typeof result === "string") {
        const root = fromHtmlIsomorphic(result, { fragment: true });
        // Cast as we don’t expect `doctypes` in KaTeX result.
        result = /** @type {Array<ElementContent>} */ root.children;
      }

      const index = parent.children.indexOf(scope);
      parent.children.splice(index, 1, ...(result as any));
      return SKIP;
    });
  };
};
